# EG8145V5 CLI Security Analysis Report
> Generated by `tools/cli_security_analysis.py` — 2026-03-01 20:46:02 UTC
> Firmware: EG8145V5-V500R022C00SPC340B019
> Target binary: `/bin/clid` (ARM, ~2.5 MB)

---

## 1. CmdGroup Access Level Bitmask System

The CLI uses a bitmask to control per-command access. Each command in `hw_cli.xml` has a `CmdGroup` attribute; the user's `UserGroup` must have the matching bits set.

| Bitmask | Description |
|---------|-------------|
| `0x00000010` | Basic user (read-only, very limited) |
| `0x00002000` | Carrier / ISP commands |
| `0x00004000` | Admin (partial) |
| `0x00004010` | Admin + basic (most display commands) |
| `0x10000000` | Hidden / factory mode |
| `0x80000000` | Super admin / engineer mode |
| `0x80000010` | Super + basic |
| `0x80002000` | Super + carrier |
| `0x80004000` | Super + admin |
| `0x80004010` | Super + admin + basic |

Setting `UserGroup="0xFFFFFFFF"` grants access to **all** command groups (600+ commands).

---

## 2. Equipment Test Mode Backdoor

The clid binary contains the strings `huaweiequiptestmode-on` and `huaweiequiptestmode-off`.

**Trigger:** When the file `/mnt/jffs2/equiptestmode` exists on the filesystem, the device enters Equipment Test Mode with elevated privileges.

**Related functions:**
- `HW_CLI_SetEquipTestMode`
- `HW_CLI_RPC_GetEquipTestMode`
- `HW_SSP_IsDebugMode`

In this mode, additional diagnostic and configuration commands become available regardless of the user's `UserGroup` setting.

---

## 3. Feature Flags Controlling Shell Access

These compile-time / runtime feature flags were found in the clid binary strings:

| Flag | Description |
|------|-------------|
| `FT_CLI_DEFAULT_TO_SHELL` | When enabled, CLI defaults to Linux shell |
| `SSMP_FT_TDE_OPEN_SHELL` | TDE open shell feature |
| `SSMP_FT_TDE_AUTH_SU_CMD` | SU command authentication |
| `SSMP_SPEC_CLI_ENABLE` | CLI enable/disable |
| `SSMP_SPEC_CLI_CUSTOMIZE_CMDLIST` | Custom command list file path |
| `FT_CLI_SECURITY_ACCESS` | Security access control |

---

## 4. Shell Access Call Chain (clid disassembly)

```
HW_CLI_Shell
  → HW_CLI_LoginTty → HW_CLI_SetShellTtyAttr
       → SSP_ExecSysCmd → /bin/sh

HW_CLI_InnerShell / HW_CLI_InnerShellEx
  → SSP_ExecShellCmd

CLI_ToShellDirect   → directly enters shell
CLI_ToShellDefault  → enters shell with default settings

HW_CLI_SU_Mode
  → "Notice: Already in SU mode" / prompts for su password
  → HW_CLI_VerifySuPassword (uses su_pub_key)
```

The key entry points are `CLI_ToShellDirect` (no auth) and `HW_CLI_SU_Mode` (requires su password verified against `su_pub_key`).

---

## 5. Configuration Vulnerabilities (hw_ctree.xml)

---

### Known Default Configuration

From the decrypted hw_ctree.xml (key index 1):

```xml
<X_HW_CLIUserInfoInstance InstanceID="1" Username="root"
    Userpassword="admin" UserGroup="" ModifyPWDFlag="0"
    EncryptMode="3"/>
<X_HW_CLITelnetAccess Access="1"/>
<AclServices TELNETLanEnable="1" TELNETWanEnable="0"
    SSHLanEnable="0" TELNETPORT="23" SSHPORT="22"/>
```

**Issues:**
1. CLI user `root` has password `admin` with `UserGroup=""` (empty = most restricted)
2. Telnet enabled on LAN with plaintext credentials
3. SSH disabled — management is Telnet-only

---

## 6. UserGroup Values and Command Access

The `UserGroup` attribute on `X_HW_CLIUserInfoInstance` controls which `CmdGroup` commands are available to that user.

- **Empty** `UserGroup=""` → most restricted (only `exit` and `getcustomerinfo`)
- Bits must match the command's `CmdGroup` for it to appear
- `UserGroup="0xFFFFFFFF"` → access to **ALL** 600+ commands

---

## 7. BusyBox Analysis

- **Version:** busybox v1.32.1 with 166 applets
- Includes: `ash`, `sh`, `telnet`, `wget`, `tftp`, `ftpget`, `ftpput`
- **busybox.suid** (79 KB, 8 SUID applets): `arping`, `login`, `passwd`, `ping`, `ping6`, `su`, `traceroute`, `traceroute6`

The `su` SUID applet allows privilege escalation if the su password is known.

---

## 8. Key CLI Commands Restricted by CmdGroup

The WAP CLI has 600+ commands defined in `hw_cli.xml`. Key commands gated by CmdGroup:

| Command | Risk | Note |
|---------|------|------|
| `display password` | HIGH | Shows stored passwords |
| `set userpasswd` | HIGH | Changes user passwords |
| `display current-configuration` | HIGH | Full config dump |
| `load cfg` | HIGH | Load config from file |
| `backup cfg` | MEDIUM | Backup config to file |
| `save data` | MEDIUM | Save running config to flash |
| `reset` | CRITICAL | Factory reset |
| `restore default configuration` | CRITICAL | Restore defaults |
| `ssh remote` | HIGH | SSH to remote host |
| `telnet remote` | HIGH | Telnet to remote host |
| `display version` | LOW | Show firmware version |
| `display firmware version` | LOW | Show firmware version |

---

## 9. Bypass: Modifying hw_ctree.xml for Full Shell Access

### Steps

1. **Decrypt** the hw_ctree.xml from NAND/backup:
   ```bash
   # Using the firmware tool's decrypt_ctree pipeline
   python3 tools/decrypt_ctree.py --dump NAND.BIN --out keys/
   # Or with aescrypt2 directly (key index 1)
   aescrypt2 1 hw_ctree.xml decrypted.xml
   ```

2. **Modify** the decrypted XML using `ctree_modifier.py`:
   ```bash
   # Grant full command access to root user
   python3 tools/ctree_modifier.py -i decrypted.xml \
       --set-usergroup root 0xFFFFFFFF

   # Enable SSH and FTP
   python3 tools/ctree_modifier.py -i decrypted.xml \
       --enable-ssh --enable-ftp
   ```

   Or manually edit:
   ```xml
   <!-- Change UserGroup to full access -->
   <X_HW_CLIUserInfoInstance ... UserGroup="0xFFFFFFFF" .../>

   <!-- Enable SSH on LAN -->
   <AclServices ... SSHLanEnable="1" .../>

   <!-- Enable FTP on LAN -->
   <AclServices ... FTPLanEnable="1" .../>
   ```

3. **Re-encrypt** and flash:
   ```bash
   aescrypt2 0 decrypted.xml hw_ctree.xml
   ```

4. **Upload** the modified hw_ctree.xml back to the device (via TFTP, backup restore, or direct NAND write).

---

## 10. Security Recommendations

1. **Change default CLI passwords** — `root`/`admin` is trivially guessable.
2. **Disable Telnet**, enable SSH — Telnet transmits credentials in plaintext.
3. **Restrict WAN management** — ensure `TELNETWanEnable` and `SSHWanEnable` are `0`.
4. **Monitor for equiptestmode file** — its presence indicates backdoor activation.
5. **Use per-user CmdGroup limits** — avoid `0xFFFFFFFF` in production.
6. **Encrypt config backups** — decrypted hw_ctree.xml exposes all credentials.
